<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monite App Drop-In Component Demo</title>
  </head>
  <body>
    <monite-app
      disabled
      entity-id="defer"
      api-url="defer"
      basename="/"
      component="defer"
    >
      <script slot="fetch-token">
        async function fetchDropInToken() {
          return await window.fetchToken();
        }
      </script>

      <script slot="theme" type="application/json">
        {
          "typography": {
            "fontFamily": "Comic Sans MS, Comic Sans, cursive, monospace"
          }
        }
      </script>

      <script slot="locale" type="application/json">
        {
          "code": "de-DE",
          "messages": {
            "Name, country, city": "City Test",
            "Payables": "My Payables"
          }
        }
      </script>
    </monite-app>

    <script type="module">
      import { createAPIClient } from '@monite/sdk-react';
      import { getConfig } from './src/lib/ConfigLoader.tsx';
      import { createEntityUsersMyEntityRequestFn } from '@team-monite/sdk-demo';
      import { fetchTokenDev } from './src/lib/fetchTokenDev.ts';
      import { MoniteEventTypes, addMoniteEventListener } from './src/lib/MoniteEvents';

      window.fetchToken = fetchTokenDev;
      let moniteAppNode;

      addMoniteEventListener(MoniteEventTypes.INVOICE_CREATED, (event) => {
        const { type, payload, id } = event.detail;
        console.log('[Event Listener] Received invoice created event:', { type, payload, id });
      });

      addMoniteEventListener(MoniteEventTypes.INVOICE_UPDATED, (event) => {
        const { type, payload, id } = event.detail;
        console.log('[Event Listener] Received invoice updated event:', { type, payload, id });
      });

      addMoniteEventListener(MoniteEventTypes.INVOICE_DELETED, (event) => {
        const { type, payload, id } = event.detail;
        console.log('[Event Listener] Received invoice deleted event:', { type, payload, id });
      });

      async function initApp() {
        let entityId;
        let apiUrl;
        try {
          const config = await getConfig();
          apiUrl = `${config.api_url}/v1`;
          const { api } = createAPIClient();

          const { id } = await api.entityUsers.getEntityUsersMyEntity(
            {
              parameters: {},
              baseUrl: apiUrl,
            },
            createEntityUsersMyEntityRequestFn(fetchTokenDev)
          );
          entityId = id;
        } catch (error) {
          console.error('Error while fetching credentials:', error);
          throw new Error('Error while fetching credentials');
        }

        const moniteApp = document.querySelector('monite-app');
        if (moniteApp) {
          moniteApp.setAttribute('component', location.pathname.split('/')[2] ?? 'receivables');
          moniteApp.setAttribute('api-url', apiUrl);
          moniteApp.setAttribute('entity-id', entityId);
          moniteApp.removeAttribute('disabled');
        } else {
          console.warn('Could not find <monite-app> element in the DOM. Make sure it is properly included in your HTML.');
        }
      }

      initApp();
    </script>

    <script type="module" src="/src/custom-elements/monite-app.ts"></script>
  </body>
</html>
