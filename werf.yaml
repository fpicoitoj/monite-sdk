configVersion: 1
project: sdkapp
---
image: sdk-react
from: cimg/node:20.12.2
docker:
  WORKDIR: /app
  USER: app
git:
  - add: /monite-sdk
    to: /app
    owner: app
    group: app
    excludePaths:
      - '.helm/**'
      - '.gitlab-ci.yml'
      - 'werf.yaml'
    stageDependencies:
      install:
        - examples/with-nextjs-and-clerk-auth/package.json
        - packages/*/package.json
        - package.json
        - yarn.lock
        - .yarnrc.yml
      setup:
        - '**/*'
shell:
  beforeInstall:
    - groupadd -g 1000 app && useradd -m -u 1000 -g app -s /bin/bash app
  install:
    - set -x
    - cd /app
    - yarn install --immutable
  setup:
    - set -x
    - cd /app
    - yarn build --filter='@monite/sdk-react'
---
image: sdk-demo-with-nextjs-and-clerk-auth
from: cimg/node:20.12.2
docker:
  WORKDIR: /app
  USER: app
import:
  - image: sdk-react
    add: /app
    to: /app
    before: setup
    owner: app
    group: app
shell:
  beforeInstall:
    - groupadd -g 1000 app && useradd -m -u 1000 -g app -s /bin/bash app
  setup:
    - set -x
    - cd /app
    - yarn build --filter='sdk-demo-with-nextjs-and-clerk-auth'

---
image: sdk-demo
from: cimg/node:20.12.2
docker:
  WORKDIR: /app
  USER: app
import:
  - image: sdk-react
    add: /app
    to: /app
    before: setup
    owner: app
    group: app
shell:
  beforeInstall:
    - groupadd -g 1000 app && useradd -m -u 1000 -g app -s /bin/bash app
  setup:
    - set -x
    - cd /app
    - yarn build --filter='@team-monite/sdk-demo'

---
image: sdk-demo-nginx
from: nginx:1.25.1
docker:
  WORKDIR: /app
  USER: app
import:
  - image: sdk-demo
    add: /app/packages/sdk-demo/build
    to: /app
    before: setup
    owner: app
    group: app
shell:
  beforeInstall:
    - groupadd -g 1000 app && useradd -m -u 1000 -g app -s /bin/bash app
    - ln -snf /usr/share/zoneinfo/Europe/Berlin /etc/localtime && echo Europe/Berlin > /etc/timezone

---
image: sdk-drop-in
from: cimg/node:20.12.2
docker:
  WORKDIR: /app
  USER: app
import:
  - image: sdk-react
    add: /app
    to: /app
    before: setup
    owner: app
    group: app
shell:
  beforeInstall:
    - groupadd -g 1000 app && useradd -m -u 1000 -g app -s /bin/bash app
  setup:
    - set -x
    - cd /app
    - yarn build --filter='@monite/sdk-drop-in'

---
image: sdk-drop-in-nginx
from: nginx:1.25.1
docker:
  WORKDIR: /app
  USER: app
import:
  - image: sdk-drop-in
    add: /app/packages/sdk-drop-in/dist
    to: /app
    before: setup
    owner: app
    group: app
shell:
  beforeInstall:
    - groupadd -g 1000 app && useradd -m -u 1000 -g app -s /bin/bash app
    - ln -snf /usr/share/zoneinfo/Europe/Berlin /etc/localtime && echo Europe/Berlin > /etc/timezone
